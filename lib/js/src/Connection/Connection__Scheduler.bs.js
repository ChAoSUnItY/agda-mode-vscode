// Generated by ReScript, PLEASE EDIT WITH CARE
'use strict';

var Caml = require("rescript/lib/js/caml.js");
var Curry = require("rescript/lib/js/curry.js");
var $$Promise = require("reason-promise/lib/js/src/js/promise.bs.js");
var Js_array = require("rescript/lib/js/js_array.js");
var Belt_Array = require("rescript/lib/js/belt_Array.js");
var Chan$AgdaModeVscode = require("../Util/Chan.bs.js");
var Util$AgdaModeVscode = require("../Util/Util.bs.js");

function make(param) {
  return {
          tally: 0,
          allDone: Chan$AgdaModeVscode.make(undefined),
          deferredLastResponses: []
        };
}

function runNonLast(self, handler, response) {
  self.tally = self.tally + 1 | 0;
  $$Promise.get(Curry._1(handler, response), (function (param) {
          self.tally = self.tally - 1 | 0;
          if (self.tally === 0) {
            return Chan$AgdaModeVscode.emit(self.allDone, undefined);
          }
          
        }));
}

function addLast(self, priority, response) {
  Js_array.push([
        priority,
        response
      ], self.deferredLastResponses);
}

function onceDone(self) {
  if (self.tally === 0) {
    return $$Promise.resolved(undefined);
  } else {
    return Chan$AgdaModeVscode.once(self.allDone);
  }
}

function runLast(self, handler) {
  $$Promise.get(onceDone(self), (function (param) {
          var deferredLastResponses = Belt_Array.map(Js_array.sortInPlaceWith((function (x, y) {
                      return Caml.int_compare(x[0], y[0]);
                    }), self.deferredLastResponses), (function (prim) {
                  return prim[1];
                }));
          Js_array.unshift(/* CompleteHighlightingAndMakePromptReappear */4, deferredLastResponses);
          Util$AgdaModeVscode.oneByOne(Belt_Array.map(deferredLastResponses, Curry.__1(handler)));
        }));
}

var Module = {
  make: make,
  addLast: addLast,
  runNonLast: runNonLast,
  runLast: runLast
};

exports.Module = Module;
exports.make = make;
exports.addLast = addLast;
exports.runNonLast = runNonLast;
exports.runLast = runLast;
/* Promise Not a pure module */
