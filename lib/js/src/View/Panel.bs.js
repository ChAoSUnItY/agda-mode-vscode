// Generated by BUCKLESCRIPT, PLEASE EDIT WITH CARE
'use strict';

var Curry = require("bs-platform/lib/js/curry.js");
var React = require("react");
var $$Promise = require("reason-promise/lib/js/src/js/promise.js");
var Caml_primitive = require("bs-platform/lib/js/caml_primitive.js");
var Body$AgdaModeVscode = require("./Body.bs.js");
var Hook$AgdaModeVscode = require("./Hook.bs.js");
var Caml_chrome_debugger = require("bs-platform/lib/js/caml_chrome_debugger.js");
var Header$AgdaModeVscode = require("./Header.bs.js");
var Keyboard$AgdaModeVscode = require("./Keyboard.bs.js");
var Translator$AgdaModeVscode = require("../InputMethod/Translator.bs.js");

function Panel(Props) {
  var onRequest = Props.onRequest;
  var onResponse = Props.onResponse;
  var match = React.useState((function () {
          return /* Plain */Caml_chrome_debugger.variant("Plain", 0, ["Loading ..."]);
        }));
  var setHeader = match[1];
  var match$1 = React.useState((function () {
          return /* Nothing */0;
        }));
  var setBody = match$1[1];
  var match$2 = React.useReducer((function (state, action) {
          if (typeof action === "number") {
            if (action === 1) {
              return ;
            }
            if (action === 0) {
              var initTranslation = Translator$AgdaModeVscode.translate("");
              return {
                      sequence: "",
                      suggestions: initTranslation.keySuggestions,
                      candidates: initTranslation.candidateSymbols,
                      candidateIndex: 0
                    };
            }
            
          }
          if (state === undefined) {
            return ;
          }
          if (typeof action !== "number") {
            return {
                    sequence: action[0],
                    suggestions: action[1],
                    candidates: action[2],
                    candidateIndex: state.candidateIndex
                  };
          }
          var candidateIndex = state.candidateIndex;
          var candidates = state.candidates;
          var suggestions = state.suggestions;
          var sequence = state.sequence;
          switch (action - 2 | 0) {
            case /* Activate */0 :
                return {
                        sequence: sequence,
                        suggestions: suggestions,
                        candidates: candidates,
                        candidateIndex: Caml_primitive.caml_int_max(0, candidateIndex - 10 | 0)
                      };
            case /* Deactivate */1 :
                return {
                        sequence: sequence,
                        suggestions: suggestions,
                        candidates: candidates,
                        candidateIndex: Caml_primitive.caml_int_min(candidates.length - 1 | 0, candidateIndex + 1 | 0)
                      };
            case /* MoveUp */2 :
                return {
                        sequence: sequence,
                        suggestions: suggestions,
                        candidates: candidates,
                        candidateIndex: Caml_primitive.caml_int_min(candidates.length - 1 | 0, candidateIndex + 10 | 0)
                      };
            case /* MoveRight */3 :
                return {
                        sequence: sequence,
                        suggestions: suggestions,
                        candidates: candidates,
                        candidateIndex: Caml_primitive.caml_int_max(0, candidateIndex - 1 | 0)
                      };
            
          }
        }), undefined);
  var runInputMethodAction = match$2[1];
  React.useEffect((function () {
          Curry._1(onResponse.emit, /* EventPiggyBack */Caml_chrome_debugger.variant("EventPiggyBack", 0, [/* Initialized */0]));
          
        }), []);
  var resolver = React.useRef(undefined);
  var onSubmit = function (result) {
    var resolve = resolver.current;
    if (resolve !== undefined) {
      Curry._1(resolve, result);
      resolver.current = undefined;
      return ;
    }
    
  };
  Hook$AgdaModeVscode.on(onRequest, onResponse, (function (msg) {
          if (typeof msg === "number") {
            switch (msg) {
              case /* Show */0 :
              case /* Hide */1 :
                  return $$Promise.resolved(/* Success */0);
              case /* InterruptQuery */2 :
                  onSubmit(undefined);
                  return $$Promise.resolved(/* QueryInterrupted */1);
              
            }
          } else {
            if (msg.tag) {
              Curry._1(runInputMethodAction, msg[0]);
              return $$Promise.resolved(/* Success */0);
            }
            var body = msg[1];
            var header = msg[0];
            if (typeof body !== "number" && body.tag) {
              var value = body[1];
              var placeholder = body[0];
              var match = $$Promise.pending(undefined);
              resolver.current = match[1];
              Curry._1(setHeader, (function (param) {
                      return header;
                    }));
              Curry._1(setBody, (function (param) {
                      return /* Query */Caml_chrome_debugger.variant("Query", 1, [
                                placeholder,
                                value
                              ]);
                    }));
              return $$Promise.map(match[0], (function (result) {
                            if (result !== undefined) {
                              return /* QuerySuccess */Caml_chrome_debugger.variant("QuerySuccess", 1, [result]);
                            } else {
                              return /* QueryInterrupted */1;
                            }
                          }));
            }
            Curry._1(setHeader, (function (param) {
                    return header;
                  }));
            Curry._1(setBody, (function (param) {
                    return body;
                  }));
            return $$Promise.resolved(/* Success */0);
          }
        }));
  return React.createElement("section", {
              className: "agda-mode native-key-bindings",
              tabIndex: -1
            }, React.createElement(Keyboard$AgdaModeVscode.make, {
                  state: match$2[0],
                  onInsertChar: (function ($$char) {
                      console.log("onInsertChar " + $$char);
                      return Curry._1(onResponse.emit, /* EventPiggyBack */Caml_chrome_debugger.variant("EventPiggyBack", 0, [/* InputMethod */Caml_chrome_debugger.simpleVariant("InputMethod", [/* InsertChar */Caml_chrome_debugger.simpleVariant("InsertChar", [$$char])])]));
                    })
                }), React.createElement(Header$AgdaModeVscode.make, {
                  header: match[0]
                }), React.createElement(Body$AgdaModeVscode.make, {
                  body: match$1[0],
                  onSubmit: onSubmit
                }));
}

var make = Panel;

exports.make = make;
/* react Not a pure module */
