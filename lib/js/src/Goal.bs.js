// Generated by ReScript, PLEASE EDIT WITH CARE
'use strict';

var VSCode = require("bs-vscode/lib/js/src/VSCode.bs.js");
var Vscode = require("vscode");
var $$Promise = require("reason-promise/lib/js/src/js/promise.bs.js");
var Belt_Array = require("bs-platform/lib/js/belt_Array.js");
var Util$AgdaModeVscode = require("./Util/Util.bs.js");
var Editor$AgdaModeVscode = require("./Editor.bs.js");
var Parser$AgdaModeVscode = require("./Parser/Parser.bs.js");
var Decoration$AgdaModeVscode = require("./Decoration.bs.js");
var SourceFile$AgdaModeVscode = require("./Parser/SourceFile.bs.js");

function generateDiffs($$document, indices) {
  var fileName = Parser$AgdaModeVscode.filepath($$document.fileName);
  var source = Editor$AgdaModeVscode.$$Text.getAll($$document);
  return SourceFile$AgdaModeVscode.parse(indices, fileName, source);
}

function makeMany(editor, indices) {
  var $$document = editor.document;
  var diffs = generateDiffs($$document, indices);
  var delta = {
    contents: 0
  };
  var replacements = Belt_Array.map(Belt_Array.keep(diffs, (function (diff) {
              return diff.changed;
            })), (function (diff) {
          var range = new Vscode.Range($$document.positionAt(diff.originalInterval[0] - delta.contents | 0), $$document.positionAt(diff.originalInterval[1] - delta.contents | 0));
          delta.contents = (delta.contents + (diff.modifiedInterval[1] - diff.modifiedInterval[0] | 0) | 0) - (diff.originalInterval[1] - diff.originalInterval[0] | 0) | 0;
          var text = diff.content;
          return [
                  range,
                  text
                ];
        }));
  return $$Promise.map(Editor$AgdaModeVscode.$$Text.batchReplace$prime(editor, replacements), (function (param) {
                return Belt_Array.map(diffs, (function (diff) {
                              var match = Decoration$AgdaModeVscode.decorateHole(editor, diff.modifiedInterval, diff.index);
                              return {
                                      index: diff.index,
                                      interval: diff.modifiedInterval,
                                      decorationBackground: match[0],
                                      decorationIndex: match[1]
                                    };
                            }));
              }));
}

function getInnerRange(self, $$document) {
  var interval_0 = self.interval[0] + 2 | 0;
  var interval_1 = self.interval[1] - 2 | 0;
  var interval = [
    interval_0,
    interval_1
  ];
  return Editor$AgdaModeVscode.$$Range.fromInterval($$document, interval);
}

function getOuterRange(self, $$document) {
  return Editor$AgdaModeVscode.$$Range.fromInterval($$document, self.interval);
}

function getContent(self, $$document) {
  var innerRange = getInnerRange(self, $$document);
  return Parser$AgdaModeVscode.userInput(Editor$AgdaModeVscode.$$Text.get($$document, innerRange));
}

function setContent(self, $$document, text) {
  var innerRange = getInnerRange(self, $$document);
  return Editor$AgdaModeVscode.$$Text.replace($$document, innerRange, " " + text + " ");
}

function setCursor(self, editor) {
  var $$document = editor.document;
  var match = self.interval;
  var position = Editor$AgdaModeVscode.Position.fromOffset($$document, match[0] + 3 | 0);
  Editor$AgdaModeVscode.Cursor.set(editor, position);
  var range = Editor$AgdaModeVscode.$$Range.fromInterval($$document, self.interval);
  return VSCode.TextEditor.revealRange(editor, range, undefined);
}

function buildHaskellRange(self, $$document, version, filepath) {
  var match = self.interval;
  var end_ = match[1];
  var start = match[0];
  var startPoint = Editor$AgdaModeVscode.Position.fromOffset($$document, start);
  var endPoint = Editor$AgdaModeVscode.Position.fromOffset($$document, end_);
  var startIndex = String(start + 3 | 0);
  var startRow = String(startPoint.line + 1 | 0);
  var startColumn = String(startPoint.character + 3 | 0);
  var startPart = "" + startIndex + " " + startRow + " " + startColumn;
  var endIndex$prime = String(end_ - 3 | 0);
  var endRow = String(endPoint.line + 1 | 0);
  var endColumn = String(endPoint.character - 1 | 0);
  var endPart = "" + endIndex$prime + " " + endRow + " " + endColumn;
  if (Util$AgdaModeVscode.Version.gte(version, "2.5.1")) {
    return "(intervalsToRange (Just (mkAbsolute \"" + filepath + "\")) [Interval (Pn () " + startPart + ") (Pn () " + endPart + ")])";
  } else {
    return "(Range [Interval (Pn (Just (mkAbsolute \"" + filepath + "\")) " + startPart + ") (Pn (Just (mkAbsolute \"" + filepath + "\")) " + endPart + ")])";
  }
}

function refreshDecoration(self, editor) {
  var range = getOuterRange(self, editor.document);
  Editor$AgdaModeVscode.Decoration.decorate(editor, self.decorationBackground, [range]);
  var range$1 = new Vscode.Range(range.start, range.end.translate(0, -2));
  return Editor$AgdaModeVscode.Decoration.decorate(editor, self.decorationIndex, [range$1]);
}

function destroy(self) {
  Editor$AgdaModeVscode.Decoration.destroy(self.decorationBackground);
  return Editor$AgdaModeVscode.Decoration.destroy(self.decorationIndex);
}

var Module = {
  buildHaskellRange: buildHaskellRange,
  generateDiffs: generateDiffs,
  makeMany: makeMany,
  getContent: getContent,
  setContent: setContent,
  setCursor: setCursor,
  getInnerRange: getInnerRange,
  refreshDecoration: refreshDecoration,
  destroy: destroy
};

exports.Module = Module;
exports.buildHaskellRange = buildHaskellRange;
exports.generateDiffs = generateDiffs;
exports.makeMany = makeMany;
exports.getContent = getContent;
exports.setContent = setContent;
exports.setCursor = setCursor;
exports.getInnerRange = getInnerRange;
exports.refreshDecoration = refreshDecoration;
exports.destroy = destroy;
/* VSCode Not a pure module */
