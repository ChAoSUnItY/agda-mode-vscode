// Generated by BUCKLESCRIPT, PLEASE EDIT WITH CARE
'use strict';

var Curry = require("bs-platform/lib/js/curry.js");
var $$Promise = require("reason-promise/lib/js/src/js/promise.js");
var Belt_Array = require("bs-platform/lib/js/belt_Array.js");
var Belt_Option = require("bs-platform/lib/js/belt_Option.js");
var Event$AgdaModeVscode = require("./Util/Event.bs.js");
var State$AgdaModeVscode = require("./State.bs.js");
var Parser$AgdaModeVscode = require("./Parser.bs.js");
var Command$AgdaModeVscode = require("./Command.bs.js");
var SigImpl$AgdaModeVscode = require("./SigImpl.bs.js");
var Registry$AgdaModeVscode = require("./Registry.bs.js");
var Dispatcher$AgdaModeVscode = require("./Task/Dispatcher.bs.js");

function Impl(Editor) {
  var Registry = Registry$AgdaModeVscode.Impl(Editor);
  var State = State$AgdaModeVscode.Impl(Editor);
  var Dispatcher = Dispatcher$AgdaModeVscode.Impl(Editor);
  var isAgda = function (filepath) {
    var filepath$1 = Parser$AgdaModeVscode.filepath(filepath);
    return /\.agda$|\.lagda/i.test(filepath$1);
  };
  var activateWithoutContext = function (disposables, extensionPath) {
    console.log("[ extention ] activate");
    var eventEmitter = Event$AgdaModeVscode.make(undefined);
    disposables.push(Curry._1(Editor.onDidCloseEditor, (function (fileName) {
                Curry._1(Registry.forceDestroy, fileName);
                
              })));
    disposables.push(Curry._1(Editor.onDidChangeFileName, (function (oldName, newName) {
                return Belt_Option.forEach(oldName, (function (oldName) {
                              return Belt_Option.forEach(newName, (function (newName) {
                                            if (Curry._1(Registry.contains, oldName)) {
                                              if (isAgda(newName)) {
                                                return Curry._2(Registry.rename, oldName, newName);
                                              } else {
                                                Curry._1(Registry.forceDestroy, oldName);
                                                return ;
                                              }
                                            }
                                            
                                          }));
                            }));
              })));
    disposables.push(Curry._1(Editor.onDidChangeActivation, (function (prev, next) {
                Belt_Option.forEach(Belt_Option.flatMap(prev, Registry.getByEditor), (function (dispatcher) {
                        return Curry._1(State.hide, dispatcher.state);
                      }));
                return Belt_Option.forEach(Belt_Option.flatMap(next, Registry.getByEditor), (function (dispatcher) {
                              Belt_Option.forEach(next, (function (editor) {
                                      dispatcher.state.editor = editor;
                                      Curry._1(State.show, dispatcher.state);
                                      Curry._2(Dispatcher.dispatchCommand, dispatcher, /* Refresh */3);
                                      
                                    }));
                              
                            }));
              })));
    var makeAndAddToRegistry = function (editor, fileName) {
      var dispatcher = Curry._4(Dispatcher.make, extensionPath, editor, (function (param) {
              Curry._1(Registry.forceDestroy, fileName);
              
            }), eventEmitter);
      return Curry._2(Registry.add, fileName, dispatcher);
    };
    Belt_Array.forEach(Command$AgdaModeVscode.names, (function (param) {
            var name = param[1];
            var command = param[0];
            disposables.push(Curry._2(Editor.registerCommand, name, (function (editor, fileName) {
                        if (!isAgda(fileName)) {
                          return $$Promise.resolved(undefined);
                        }
                        console.log("[ command ] " + name);
                        var tmp;
                        var exit = 0;
                        if (typeof command === "number") {
                          switch (command) {
                            case /* Load */0 :
                                exit = 1;
                                break;
                            case /* Quit */1 :
                                tmp = Curry._1(Registry.forceDestroy, fileName);
                                break;
                            case /* Restart */2 :
                                tmp = $$Promise.map(Curry._1(Registry.destroy, fileName), (function (param) {
                                        return makeAndAddToRegistry(editor, fileName);
                                      }));
                                break;
                            default:
                              tmp = $$Promise.resolved(undefined);
                          }
                        } else if (command.tag === /* InputMethod */13) {
                          var match = command[0];
                          if (typeof match === "number" && match === 0) {
                            exit = 1;
                          } else {
                            tmp = $$Promise.resolved(undefined);
                          }
                        } else {
                          tmp = $$Promise.resolved(undefined);
                        }
                        if (exit === 1) {
                          var match$1 = Curry._1(Registry.get, fileName);
                          if (match$1 !== undefined) {
                            
                          } else {
                            makeAndAddToRegistry(editor, fileName);
                          }
                          tmp = $$Promise.resolved(undefined);
                        }
                        return $$Promise.flatMap(tmp, (function (param) {
                                      var dispatcher = Curry._1(Registry.get, fileName);
                                      if (dispatcher !== undefined) {
                                        return Curry._2(Dispatcher.dispatchCommand, dispatcher, command);
                                      } else {
                                        return $$Promise.resolved(undefined);
                                      }
                                    }));
                      })));
            
          }));
    return eventEmitter;
  };
  var activate = function (context) {
    var disposables = Curry._1(Editor.getDisposables, context);
    var extensionPath = Curry._1(Editor.getExtensionPath, context);
    return activateWithoutContext(disposables, extensionPath);
  };
  var deactivate = function (param) {
    console.log("[ extention ] deactivate");
    return Curry._1(Registry.destroyAll, undefined);
  };
  return {
          Registry: Registry,
          State: State,
          Dispatcher: Dispatcher,
          isAgda: isAgda,
          activateWithoutContext: activateWithoutContext,
          activate: activate,
          deactivate: deactivate
        };
}

var Editor_Point = {
  line: SigImpl$AgdaModeVscode.Point.line,
  column: SigImpl$AgdaModeVscode.Point.column,
  make: SigImpl$AgdaModeVscode.Point.make,
  translate: SigImpl$AgdaModeVscode.Point.translate,
  compare: SigImpl$AgdaModeVscode.Point.compare
};

var Editor_Config = {
  getAgdaPath: SigImpl$AgdaModeVscode.Config.getAgdaPath,
  setAgdaPath: SigImpl$AgdaModeVscode.Config.setAgdaPath,
  getLibraryPath: SigImpl$AgdaModeVscode.Config.getLibraryPath,
  getHighlightingMethod: SigImpl$AgdaModeVscode.Config.getHighlightingMethod,
  getBackend: SigImpl$AgdaModeVscode.Config.getBackend
};

var Editor_View = {
  make: SigImpl$AgdaModeVscode.View.make,
  destroy: SigImpl$AgdaModeVscode.View.destroy,
  show: SigImpl$AgdaModeVscode.View.show,
  hide: SigImpl$AgdaModeVscode.View.hide,
  focus: SigImpl$AgdaModeVscode.View.focus,
  send: SigImpl$AgdaModeVscode.View.send,
  onEvent: SigImpl$AgdaModeVscode.View.onEvent,
  fromPosition: SigImpl$AgdaModeVscode.View.fromPosition,
  fromInterval: SigImpl$AgdaModeVscode.View.fromInterval
};

var Editor_Decoration = {
  decorate: SigImpl$AgdaModeVscode.Decoration.decorate,
  highlightBackground: SigImpl$AgdaModeVscode.Decoration.highlightBackground,
  highlightBackgroundWithColor: SigImpl$AgdaModeVscode.Decoration.highlightBackgroundWithColor,
  decorateText: SigImpl$AgdaModeVscode.Decoration.decorateText,
  decorateTextWithColor: SigImpl$AgdaModeVscode.Decoration.decorateTextWithColor,
  overlayText: SigImpl$AgdaModeVscode.Decoration.overlayText,
  overlayTextWithColor: SigImpl$AgdaModeVscode.Decoration.overlayTextWithColor,
  underlineText: SigImpl$AgdaModeVscode.Decoration.underlineText,
  destroy: SigImpl$AgdaModeVscode.Decoration.destroy
};

var Editor = {
  Disposable: SigImpl$AgdaModeVscode.Disposable,
  Point: Editor_Point,
  pointAtOffset: SigImpl$AgdaModeVscode.pointAtOffset,
  offsetAtPoint: SigImpl$AgdaModeVscode.offsetAtPoint,
  $$Range: SigImpl$AgdaModeVscode.$$Range,
  editorType: SigImpl$AgdaModeVscode.editorType,
  getExtensionPath: SigImpl$AgdaModeVscode.getExtensionPath,
  getFileName: SigImpl$AgdaModeVscode.getFileName,
  openEditor: SigImpl$AgdaModeVscode.openEditor,
  openEditorWithContent: SigImpl$AgdaModeVscode.openEditorWithContent,
  save: SigImpl$AgdaModeVscode.save,
  onDidChangeFileName: SigImpl$AgdaModeVscode.onDidChangeFileName,
  onDidChangeActivation: SigImpl$AgdaModeVscode.onDidChangeActivation,
  onDidCloseEditor: SigImpl$AgdaModeVscode.onDidCloseEditor,
  registerCommand: SigImpl$AgdaModeVscode.registerCommand,
  setContext: SigImpl$AgdaModeVscode.setContext,
  getDisposables: SigImpl$AgdaModeVscode.getDisposables,
  Config: Editor_Config,
  View: Editor_View,
  Decoration: Editor_Decoration,
  focus: SigImpl$AgdaModeVscode.focus,
  reveal: SigImpl$AgdaModeVscode.reveal,
  getSelection: SigImpl$AgdaModeVscode.getSelection,
  getSelections: SigImpl$AgdaModeVscode.getSelections,
  setSelection: SigImpl$AgdaModeVscode.setSelection,
  setSelections: SigImpl$AgdaModeVscode.setSelections,
  getCursorPosition: SigImpl$AgdaModeVscode.getCursorPosition,
  getCursorPositions: SigImpl$AgdaModeVscode.getCursorPositions,
  setCursorPosition: SigImpl$AgdaModeVscode.setCursorPosition,
  setCursorPositions: SigImpl$AgdaModeVscode.setCursorPositions,
  onChangeCursorPosition: SigImpl$AgdaModeVscode.onChangeCursorPosition,
  rangeForLine: SigImpl$AgdaModeVscode.rangeForLine,
  OffsetIntervals: SigImpl$AgdaModeVscode.OffsetIntervals,
  fromUTF8Offset: SigImpl$AgdaModeVscode.fromUTF8Offset,
  toUTF8Offset: SigImpl$AgdaModeVscode.toUTF8Offset,
  getText: SigImpl$AgdaModeVscode.getText,
  getTextInRange: SigImpl$AgdaModeVscode.getTextInRange,
  selectText: SigImpl$AgdaModeVscode.selectText,
  replaceText: SigImpl$AgdaModeVscode.replaceText,
  insertText: SigImpl$AgdaModeVscode.insertText,
  insertTexts: SigImpl$AgdaModeVscode.insertTexts,
  deleteText: SigImpl$AgdaModeVscode.deleteText,
  onChange: SigImpl$AgdaModeVscode.onChange,
  copyToClipboard: SigImpl$AgdaModeVscode.copyToClipboard,
  colorThemeIsDark: SigImpl$AgdaModeVscode.colorThemeIsDark,
  lineEndingIsCRLF: SigImpl$AgdaModeVscode.lineEndingIsCRLF
};

var Registry = Registry$AgdaModeVscode.Impl(Editor);

var State = State$AgdaModeVscode.Impl(Editor);

var Dispatcher = Dispatcher$AgdaModeVscode.Impl(Editor);

function isAgda(filepath) {
  var filepath$1 = Parser$AgdaModeVscode.filepath(filepath);
  return /\.agda$|\.lagda/i.test(filepath$1);
}

function activateWithoutContext(disposables, extensionPath) {
  console.log("[ extention ] activate");
  var eventEmitter = Event$AgdaModeVscode.make(undefined);
  disposables.push(SigImpl$AgdaModeVscode.onDidCloseEditor((function (fileName) {
              Curry._1(Registry.forceDestroy, fileName);
              
            })));
  disposables.push(SigImpl$AgdaModeVscode.onDidChangeFileName((function (oldName, newName) {
              return Belt_Option.forEach(oldName, (function (oldName) {
                            return Belt_Option.forEach(newName, (function (newName) {
                                          if (Curry._1(Registry.contains, oldName)) {
                                            if (isAgda(newName)) {
                                              return Curry._2(Registry.rename, oldName, newName);
                                            } else {
                                              Curry._1(Registry.forceDestroy, oldName);
                                              return ;
                                            }
                                          }
                                          
                                        }));
                          }));
            })));
  disposables.push(SigImpl$AgdaModeVscode.onDidChangeActivation((function (prev, next) {
              Belt_Option.forEach(Belt_Option.flatMap(prev, Registry.getByEditor), (function (dispatcher) {
                      return Curry._1(State.hide, dispatcher.state);
                    }));
              return Belt_Option.forEach(Belt_Option.flatMap(next, Registry.getByEditor), (function (dispatcher) {
                            Belt_Option.forEach(next, (function (editor) {
                                    dispatcher.state.editor = editor;
                                    Curry._1(State.show, dispatcher.state);
                                    Curry._2(Dispatcher.dispatchCommand, dispatcher, /* Refresh */3);
                                    
                                  }));
                            
                          }));
            })));
  var makeAndAddToRegistry = function (editor, fileName) {
    var dispatcher = Curry._4(Dispatcher.make, extensionPath, editor, (function (param) {
            Curry._1(Registry.forceDestroy, fileName);
            
          }), eventEmitter);
    return Curry._2(Registry.add, fileName, dispatcher);
  };
  Belt_Array.forEach(Command$AgdaModeVscode.names, (function (param) {
          var name = param[1];
          var command = param[0];
          disposables.push(SigImpl$AgdaModeVscode.registerCommand(name, (function (editor, fileName) {
                      if (!isAgda(fileName)) {
                        return $$Promise.resolved(undefined);
                      }
                      console.log("[ command ] " + name);
                      var tmp;
                      var exit = 0;
                      if (typeof command === "number") {
                        switch (command) {
                          case /* Load */0 :
                              exit = 1;
                              break;
                          case /* Quit */1 :
                              tmp = Curry._1(Registry.forceDestroy, fileName);
                              break;
                          case /* Restart */2 :
                              tmp = $$Promise.map(Curry._1(Registry.destroy, fileName), (function (param) {
                                      return makeAndAddToRegistry(editor, fileName);
                                    }));
                              break;
                          default:
                            tmp = $$Promise.resolved(undefined);
                        }
                      } else if (command.tag === /* InputMethod */13) {
                        var match = command[0];
                        if (typeof match === "number" && match === 0) {
                          exit = 1;
                        } else {
                          tmp = $$Promise.resolved(undefined);
                        }
                      } else {
                        tmp = $$Promise.resolved(undefined);
                      }
                      if (exit === 1) {
                        var match$1 = Curry._1(Registry.get, fileName);
                        if (match$1 !== undefined) {
                          
                        } else {
                          makeAndAddToRegistry(editor, fileName);
                        }
                        tmp = $$Promise.resolved(undefined);
                      }
                      return $$Promise.flatMap(tmp, (function (param) {
                                    var dispatcher = Curry._1(Registry.get, fileName);
                                    if (dispatcher !== undefined) {
                                      return Curry._2(Dispatcher.dispatchCommand, dispatcher, command);
                                    } else {
                                      return $$Promise.resolved(undefined);
                                    }
                                  }));
                    })));
          
        }));
  return eventEmitter;
}

function activate(context) {
  var disposables = SigImpl$AgdaModeVscode.getDisposables(context);
  var extensionPath = SigImpl$AgdaModeVscode.getExtensionPath(context);
  return activateWithoutContext(disposables, extensionPath);
}

function deactivate(param) {
  console.log("[ extention ] deactivate");
  return Curry._1(Registry.destroyAll, undefined);
}

exports.Impl = Impl;
exports.Registry = Registry;
exports.State = State;
exports.Dispatcher = Dispatcher;
exports.isAgda = isAgda;
exports.activateWithoutContext = activateWithoutContext;
exports.activate = activate;
exports.deactivate = deactivate;
/* Registry Not a pure module */
